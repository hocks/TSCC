#!/usr/bin/perl
#
# find-outlyers -- Extract statistical outlyers from the jobdist.dat file
#                  generated by jobstats
# Copyright 2006 Ohio Supercomputer Center
# Revision info:
# $HeadURL: http://svn.osc.edu/repos/pbstools/releases/pbstools-2.0/sbin/find-outlyers $
# $Revision: 94 $
# $Date: 2006-02-15 14:02:30 -0500 (Wed, 15 Feb 2006) $
#
# Usage:  find-outlyers [-f file] [-q queue_time_threshold]
#                       [ -m mem_per_proc_theshold] [-t run_time_threshold]
#
# At least one of {-m,-q,-t} must be specified.  If more than one is specified,
# any job fitting any one of the criteria will be printed.
#
# If no file is specified, STDIN is used.

open(FILE,"<-");
# argument parsing
while ( $ARGV[0] =~ /^-.*/ )
  {
    if ( $ARGV[0] eq "-f" )
      {
	close(FILE);
	open(FILE,"<$ARGV[1]");
	shift(@ARGV);
      }
    elsif ( $ARGV[0] eq "-m" )
      {
	$maxmem=$ARGV[1];
	shift(@ARGV);
      }
    elsif ( $ARGV[0] eq "-q" )
      {
	$maxqtime=$ARGV[1];
	shift(@ARGV);
      }
    elsif ( $ARGV[0] eq "-t" )
      {
	$maxtime=$ARGV[1];
	shift(@ARGV);
      }
    else
      {
	print STDERR "$0:  Unrecognized argument $ARGV[0]\n";
      }
    shift(@ARGV);
  }

# process input
while ( <FILE> )
  {
    chop;
    # ignore comments and whitespace
    if ( !( $_ =~ m/^#.*$/ ) && !( $_ =~ m/^\s$/ ) )
      {
	($jobid,$procs,$qtime,$runtime,$mem)=split(/\s+/);
	if ( ( defined($maxqtime) && $qtime>$maxqtime ) ||
	     ( defined($maxtime) && $runtime>$maxtime ) ||
	     ( defined($maxmem) && ($mem/$nprocs)>$maxmem ) )
	  {
	    print "$_\n";
	  }
      }
  }

